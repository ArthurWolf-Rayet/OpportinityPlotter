<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Padua Redemption: Opportunity Map</title>
<style>
:root{
  /* Sci-fi palette */
  --bg0:#05070c; --bg1:#070b12;
  --panel: rgba(10, 16, 26, 0.72);
  --border: rgba(110, 240, 255, 0.22);
  --text: rgba(235, 250, 255, 0.92);
  --muted: rgba(235, 250, 255, 0.62);
  --cyan: rgba(110, 240, 255, 0.95);
  --purple: rgba(180, 120, 255, 0.95);
  --good: rgba(120, 255, 200, 0.95);
  --bad: rgba(255, 120, 140, 0.95);
}

*{box-sizing:border-box}
html, body { height: 100%; overflow: hidden; }
body{
  margin:0; 
  display:flex; flex-direction: column; align-items:center; justify-content: center;
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
  background:
    radial-gradient(1200px 700px at 20% 15%, rgba(110,240,255,0.12), transparent 55%),
    radial-gradient(1000px 650px at 80% 30%, rgba(180,120,255,0.10), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

.wrap{
    width: 95vw;
    height: 95vh;
    display: flex; flex-direction: column;
    text-align:center;
}

h1{
  margin: 0 0 4px;
  font-size: clamp(24px, 3vw, 42px);
  letter-spacing: .12em;
  text-transform: uppercase;
  font-weight: 800;
  text-shadow: 0 0 18px rgba(110,240,255,0.18);
}
.subtitle {
    margin-bottom: 12px; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; font-size: 12px;
}

.card{
  flex: 1; 
  display: flex; flex-direction: column;
  background: linear-gradient(180deg, rgba(10,16,26,0.78), rgba(7,10,16,0.72));
  border: 1px solid rgba(110,240,255,0.18);
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.55), 0 0 0 1px rgba(180,120,255,0.10) inset;
  padding: 18px;
  position:relative;
  overflow: hidden; 
}

/* TOPBAR */
.topbar{
  display:flex; gap:12px; flex-wrap:wrap;
  align-items:stretch; justify-content:space-between;
  margin-bottom:10px;
  flex-shrink: 0;
}
.pill{
  flex:1 1 200px;
  background: linear-gradient(180deg, rgba(10,16,26,0.70), rgba(8,12,20,0.62));
  border: 1px solid rgba(110,240,255,0.16);
  border-radius: 16px;
  padding: 10px 14px;
  min-height: 70px;
  display:flex; flex-direction: column; justify-content: center;
  box-shadow: 0 0 0 1px rgba(180,120,255,0.08) inset;
}
.pill-title { font-weight: 700; color: var(--text); font-size: 13px; margin-bottom: 6px; text-transform: uppercase;}

/* UPLOAD BUTTON */
input[type="file"] { display: none; }
.btn-upload {
    display: inline-block;
    border: 1px dashed rgba(110,240,255,0.4);
    background: rgba(110,240,255,0.05);
    color: var(--cyan);
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 11px; text-align: center;
    transition: all 0.2s;
}
.btn-upload:hover { background: rgba(110,240,255,0.15); border-color: var(--cyan); }

/* PROGRESS BAR */
.progress-container {
    background: rgba(0,0,0,0.4);
    border-radius: 99px; height: 10px; width: 100%;
    border: 1px solid rgba(110,240,255,0.2);
    overflow: hidden; margin-top: 5px;
}
.progress-fill {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--cyan), var(--purple));
    transition: width 0.4s ease;
    box-shadow: 0 0 10px rgba(110,240,255,0.3);
}

/* MAIN VIEW AREA */
.viewport-wrapper {
    flex: 1; 
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 10px;
    overflow: hidden; 
}

/* The Map Container dimensions are set by JS */
.map-viewport {
    border: 2px solid rgba(110,240,255,0.3);
    background: #000;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    transition: transform 1.5s cubic-bezier(0.19, 1, 0.22, 1), opacity 1.5s ease;
    /* Default starting size (16:9 ratio) */
    width: 640px; height: 360px; 
}

.map-viewport.collapsed {
    transform: scale(0.01) rotate(90deg);
    opacity: 0;
    border-color: var(--good);
    box-shadow: 0 0 100px var(--good);
}

/* Image Layer */
.map-image {
    width: 100%; height: 100%;
    object-fit: fill; /* Ensures image stretches to match exact grid dimensions */
    opacity: 0.8;
    position: absolute; top:0; left:0; z-index: 0;
}

/* Grid Overlay */
.grid-overlay {
    position: absolute; inset: 0; pointer-events: none; z-index: 10;
    /* Background size is set by JS to match calculated cell size */
    background-image: 
        linear-gradient(to right, rgba(110,240,255,0.15) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(110,240,255,0.15) 1px, transparent 1px);
}

/* Map Objects */
.map-obj {
    position: absolute;
    /* Width/Height set by JS */
    cursor: grab;
    z-index: 20;
    user-select: none;
    transition: filter 0.2s;
}
.map-obj:active { cursor: grabbing; }
.map-obj.selected {
    filter: drop-shadow(0 0 6px #fff);
    outline: 2px solid #fff;
}

/* CONTROLS */
.controls-bar {
    display: flex; justify-content: center; gap: 15px; margin-top: auto; padding-top: 10px;
    flex-shrink: 0;
}
button.spawn-btn {
    border: 1px solid rgba(110,240,255,0.18);
    background: linear-gradient(180deg, rgba(18,28,44,0.75), rgba(8,12,20,0.70));
    color: var(--text); padding: 10px 20px; border-radius: 999px;
    cursor:pointer; font-weight: 750; text-transform: uppercase; font-size: 12px;
    transition: all .2s ease;
    box-shadow: 0 0 0 1px rgba(180,120,255,0.06) inset;
}
button.spawn-btn:hover { filter: brightness(1.2); border-color:var(--cyan); }
button.spawn-btn:active { transform: scale(.98); }

/* STATUS FORM */
.status-form { display: none; flex-direction: column; gap: 5px; width: 100%; }
.status-form.active { display: flex; }
.form-row { display: flex; gap: 5px; align-items: center; justify-content: space-between; }
.form-label { font-size: 10px; color: var(--muted); width: 40px; }
.form-input { 
    flex: 1; 
    background: rgba(0,0,0,0.3); border: 1px solid rgba(110,240,255,0.2);
    color: var(--cyan); font-size: 11px; padding: 4px 6px; border-radius: 4px;
    font-family: ui-monospace, monospace;
    transition: box-shadow 0.3s, border-color 0.3s;
}
.form-input:focus { outline: none; border-color: var(--cyan); }
.form-input.glow-purple { border-color: var(--purple); box-shadow: 0 0 12px var(--purple); }

.empty-msg { font-size: 12px; color: var(--muted); font-style: italic; text-align: center; margin-top: 10px;}

.btn-encrypt {
    width: 100%; margin-top: 5px;
    background: var(--purple); color: #000; border: 1px solid #fff;
    box-shadow: 0 0 15px var(--purple); animation: pulse 2s infinite;
    padding: 10px; border-radius: 8px; font-weight: 800; cursor: pointer;
    text-transform: uppercase; letter-spacing: 0.1em;
}
@keyframes pulse { 50% { box-shadow: 0 0 5px var(--purple); } }

</style>
</head>

<body> 
<div class="wrap"> 
    <h1>Opportunity Map</h1>
    <div class="subtitle">Create a map of value using 2km Altitude Imaging</div>

    <div class="card">
        
        <div class="topbar">
            <div class="pill">
                <span class="pill-title">Source Data</span>
                <label for="imgUpload" class="btn-upload">Upload Image</label>
                <input type="file" id="imgUpload" accept="image/*">
                <div style="font-size:10px; color:var(--muted); margin-top:5px; text-align:center;" id="fileNameDisplay">No Data</div>
            </div>

            <div class="pill" style="flex: 2;">
                <span class="pill-title">Object Analysis</span>
                <div id="statusContent">
                    <div class="empty-msg">Select an object on the map to analyze</div>
                </div>
            </div>

            <div class="pill">
                <span class="pill-title">Value of Map Data</span>
                <div id="progressArea">
                    <div class="sub" style="font-size:11px; margin-bottom:4px;">Data Complexity: <span id="pctText">0%</span></div>
                    <div class="progress-container">
                        <div class="progress-fill" id="progBar"></div>
                    </div>
                </div>
                <button id="btnEncrypt" class="btn-encrypt" style="display:none;">Encrypt Data</button>
            </div>
        </div>

        <div class="viewport-wrapper">
            <div class="map-viewport" id="mapContainer">
                <div class="grid-overlay" id="gridOverlay"></div>
                <img id="mapImage" class="map-image" src="" style="display:none;">
                <div id="objLayer"></div>
            </div>
        </div>

        <div class="controls-bar">
            <button class="spawn-btn" onclick="spawnObject('ROCK')">+ New Rock</button>
            <button class="spawn-btn" onclick="spawnObject('GEM')">+ New Gem</button>
            <button class="spawn-btn" onclick="spawnObject('WRECK')">+ New Wreckage</button>
        </div>

    </div>
    <div style="margin-top:10px; font-size:12px; color:rgba(235,250,255,0.4);">
        PADUA REDEMPTION â€¢ CARTOGRAPHY MODULE
    </div>
</div> 

<script>
/**
 * OPPORTUNITY MAP LOGIC
 */

// Global State
const objects = []; 
let selectedId = null;
let dragId = null;
let offset = { x:0, y:0 };
let currentCellSize = 20; // Default placeholder
let imageLoaded = false;

// DOM
const mapContainer = document.getElementById('mapContainer');
const gridOverlay = document.getElementById('gridOverlay');
const mapImage = document.getElementById('mapImage');
const objLayer = document.getElementById('objLayer');
const statusContent = document.getElementById('statusContent');
const progBar = document.getElementById('progBar');
const pctText = document.getElementById('pctText');
const btnEncrypt = document.getElementById('btnEncrypt');
const progressArea = document.getElementById('progressArea');
const imgUpload = document.getElementById('imgUpload');
const fileNameDisplay = document.getElementById('fileNameDisplay');

// --- 1. Image Upload & Scaling Logic ---
imgUpload.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = function(event){
            // Create a temp image to read natural dims
            const img = new Image();
            img.onload = function() {
                setupViewport(img.width, img.height);
                mapImage.src = event.target.result;
                mapImage.style.display = 'block';
                fileNameDisplay.textContent = file.name;
                imageLoaded = true;
            };
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }
});

function setupViewport(naturalW, naturalH) {
    // 1. Determine available space (85vw width, 55vh height limit)
    const maxWidth = window.innerWidth * 0.85;
    const maxHeight = window.innerHeight * 0.55;

    // 2. Scale image to fit within bounds (Aspect Ratio preserved initially)
    let displayW = naturalW;
    let displayH = naturalH;
    const ratio = naturalW / naturalH;

    // Fit Height first
    if (displayH > maxHeight) {
        displayH = maxHeight;
        displayW = displayH * ratio;
    }
    // Fit Width
    if (displayW > maxWidth) {
        displayW = maxWidth;
        displayH = displayW / ratio;
    }

    // 3. Grid Calculation
    // We need exactly 32 cells vertically.
    const cellsVertical = 32;
    // Calculate exact pixel size of one cell based on fit height
    const cellSize = displayH / cellsVertical;
    currentCellSize = cellSize;

    // Calculate how many FULL cells fit horizontally
    const cellsHorizontal = Math.round(displayW / cellSize);

    // 4. Force "Perfect Grid" Dimensions
    // Adjust width so there are no partial cells. 
    // Image will slightly stretch/squash to fit this perfect grid.
    const finalW = cellsHorizontal * cellSize;
    const finalH = cellsVertical * cellSize; // Should match displayH, but explicit is safer

    // 5. Apply Dimensions
    mapContainer.style.width = finalW + 'px';
    mapContainer.style.height = finalH + 'px';
    
    // 6. Apply Grid Overlay Size
    gridOverlay.style.backgroundSize = `${cellSize}px ${cellSize}px`;
    
    // Clear old objects on new upload? (Optional, but usually safer)
    // objLayer.innerHTML = '';
    // objects.length = 0;
}

// --- 2. Spawning Objects ---
function spawnObject(type) {
    if(!imageLoaded) {
        alert("Please upload a map image first.");
        return;
    }

    const id = Date.now() + Math.random();
    
    // Config based on type
    let src = "";
    let fields = [];
    
    if(type === 'ROCK') {
        src = "boulder.png";
        fields = ['TYPE', 'MASS', 'INST', 'RES'];
    } else if(type === 'GEM') {
        src = "gem.png";
        fields = ['MINERAL', 'MASS'];
    } else if(type === 'WRECK') {
        src = "Salvage.png";
        fields = ['SIG', 'MASS', 'TYPE'];
    }

    // Default center placement (snapped)
    const centerX = Math.floor((mapContainer.offsetWidth / currentCellSize) / 2) * currentCellSize;
    const centerY = Math.floor((mapContainer.offsetHeight / currentCellSize) / 2) * currentCellSize;

    const objData = {
        id: id,
        type: type,
        x: centerX,
        y: centerY,
        src: src,
        fields: fields,
        values: {} 
    };

    fields.forEach(f => objData.values[f] = "");
    objects.push(objData);

    // Create DOM Element
    const img = document.createElement('img');
    img.src = src;
    img.className = 'map-obj';
    img.id = id;
    
    // Set size to EXACTLY one grid square
    img.style.width = currentCellSize + 'px';
    img.style.height = currentCellSize + 'px';
    
    img.style.left = objData.x + 'px';
    img.style.top = objData.y + 'px';
    
    // Fallback for missing images
    img.onerror = () => {
        img.style.background = type==='GEM' ? '#f0f' : (type==='WRECK' ? '#0ff' : '#aaa');
        img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; 
    };

    img.addEventListener('mousedown', (e) => startDrag(e, id));
    
    objLayer.appendChild(img);
    selectObject(id);
    updateProgress();
}

// --- 3. Drag & Drop Logic (Pixel Snapping) ---
function startDrag(e, id) {
    e.preventDefault(); 
    dragId = id;
    selectObject(id); 

    const el = document.getElementById(id);
    const rect = el.getBoundingClientRect();
    
    // Calculate offset within the object (in pixels)
    offset.x = e.clientX - rect.left;
    offset.y = e.clientY - rect.top;

    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
}

function onDrag(e) {
    if(!dragId) return;

    const containerRect = mapContainer.getBoundingClientRect();
    
    // Calculate raw position relative to container
    let rawX = e.clientX - containerRect.left - offset.x;
    let rawY = e.clientY - containerRect.top - offset.y;

    // Snap to Grid
    let snapX = Math.round(rawX / currentCellSize) * currentCellSize;
    let snapY = Math.round(rawY / currentCellSize) * currentCellSize;

    // Boundaries
    const maxX = containerRect.width - currentCellSize;
    const maxY = containerRect.height - currentCellSize;

    if(snapX < 0) snapX = 0;
    if(snapX > maxX) snapX = maxX;
    if(snapY < 0) snapY = 0;
    if(snapY > maxY) snapY = maxY;

    // Update Data
    const obj = objects.find(o => o.id == dragId);
    obj.x = snapX;
    obj.y = snapY;

    // Update Visuals
    const el = document.getElementById(dragId);
    el.style.left = snapX + 'px';
    el.style.top = snapY + 'px';
}

function stopDrag() {
    dragId = null;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
}

// --- 4. Selection & Status Window ---
function selectObject(id) {
    selectedId = id;
    document.querySelectorAll('.map-obj').forEach(el => el.classList.remove('selected'));
    document.getElementById(id).classList.add('selected');
    renderStatusWindow(id);
}

function renderStatusWindow(id) {
    const obj = objects.find(o => o.id == id);
    statusContent.innerHTML = ''; 

    const form = document.createElement('div');
    form.className = 'status-form active';

    const head = document.createElement('div');
    head.innerHTML = `<strong style="color:var(--cyan)">${obj.type} DETECTED</strong>`;
    head.style.marginBottom = "5px";
    head.style.fontSize = "11px";
    form.appendChild(head);

    obj.fields.forEach(field => {
        const row = document.createElement('div');
        row.className = 'form-row';
        row.innerHTML = `
            <span class="form-label">${field}</span>
            <input type="text" class="form-input" maxlength="40" 
             value="${obj.values[field] || ''}" 
             data-field="${field}">
        `;
        form.appendChild(row);
    });

    statusContent.appendChild(form);

    const inputs = form.querySelectorAll('input');
    inputs.forEach(inp => {
        inp.addEventListener('input', (e) => {
            const f = e.target.dataset.field;
            obj.values[f] = e.target.value;
            
            // Purple Glow
            e.target.classList.add('glow-purple');
            setTimeout(() => { e.target.classList.remove('glow-purple'); }, 500);

            updateProgress(); 
        });
    });
}

// --- 5. Progress Logic ---
function updateProgress() {
    let totalScore = 0;
    objects.forEach(obj => {
        totalScore += 9; 
        obj.fields.forEach(f => {
            if(obj.values[f] && obj.values[f].trim().length > 0) {
                totalScore += 5;
            }
        });
    });

    if(totalScore > 100) totalScore = 100;

    progBar.style.width = totalScore + '%';
    pctText.textContent = totalScore + '%';

    if(totalScore >= 100) {
        progressArea.style.display = 'none';
        btnEncrypt.style.display = 'block';
    } else {
        progressArea.style.display = 'block';
        btnEncrypt.style.display = 'none';
    }
}

// --- 6. End Game Animation ---
btnEncrypt.addEventListener('click', () => {
    btnEncrypt.disabled = true;
    btnEncrypt.textContent = "TRANSMITTING...";
    mapContainer.classList.add('collapsed');
    setTimeout(() => {
        statusContent.innerHTML = '<div style="color:var(--good); font-weight:bold; text-align:center;">DATA SECURED.<br>PACKET SENT.</div>';
    }, 1200);
});

</script>
</body>
</html>
